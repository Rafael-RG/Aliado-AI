# Configuraci√≥n de Nginx para Aliado AI

## üìÑ Archivo de configuraci√≥n: `/etc/nginx/sites-available/aliado.ai`

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name aliado.ai www.aliado.ai;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name aliado.ai www.aliado.ai;

    # SSL Configuration (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/aliado.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/aliado.ai/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/aliado.ai/chain.pem;

    # SSL Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Frontend React App
    location / {
        root /var/www/aliado.ai/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API Backend (Reverse Proxy)
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Health endpoint
    location /health {
        proxy_pass http://localhost:5000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Legal pages (handled by React Router)
    location /legal {
        root /var/www/aliado.ai/dist;
        try_files $uri /index.html;
    }

    location /privacy {
        root /var/www/aliado.ai/dist;
        try_files $uri /index.html;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/aliado.ai/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Favicon
    location /favicon.ico {
        root /var/www/aliado.ai/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Robots.txt
    location /robots.txt {
        root /var/www/aliado.ai/dist;
        expires 1d;
    }

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}
```

## üöÄ Comandos de Deployment

### 1. Construir el frontend
```bash
npm run build
```

### 2. Copiar archivos al servidor
```bash
# Copiar build del frontend
sudo cp -r dist/* /var/www/aliado.ai/dist/

# Asegurar permisos correctos
sudo chown -R www-data:www-data /var/www/aliado.ai/
sudo chmod -R 755 /var/www/aliado.ai/
```

### 3. Habilitar configuraci√≥n de Nginx
```bash
# Crear symlink
sudo ln -s /etc/nginx/sites-available/aliado.ai /etc/nginx/sites-enabled/

# Verificar configuraci√≥n
sudo nginx -t

# Reiniciar Nginx
sudo systemctl reload nginx
```

### 4. Configurar SSL con Let's Encrypt
```bash
# Instalar Certbot
sudo apt install certbot python3-certbot-nginx

# Obtener certificado
sudo certbot --nginx -d aliado.ai -d www.aliado.ai

# Verificar renovaci√≥n autom√°tica
sudo certbot renew --dry-run
```

## üîß Verificaci√≥n

### URLs que deben funcionar despu√©s del deployment:

‚úÖ **Aplicaci√≥n principal:**
- https://aliado.ai/
- https://aliado.ai/dashboard
- https://aliado.ai/profile

‚úÖ **P√°ginas legales:**
- https://aliado.ai/legal ‚Üê **Meta WhatsApp Terms URL**
- https://aliado.ai/privacy ‚Üê **Meta WhatsApp Privacy URL**

‚úÖ **API Backend:**
- https://aliado.ai/api/health
- https://aliado.ai/api/whatsapp/webhook/{botId}

‚úÖ **Documentaci√≥n:**
- https://aliado.ai/swagger (si est√° habilitado en producci√≥n)

## üõ°Ô∏è Configuraci√≥n de Meta WhatsApp Business

Al registrar tu aplicaci√≥n en [Meta for Developers](https://developers.facebook.com/):

1. **App Details:**
   - Terms of Service URL: `https://aliado.ai/legal`
   - Privacy Policy URL: `https://aliado.ai/privacy`

2. **WhatsApp Product:**
   - Webhook URL: `https://aliado.ai/api/whatsapp/webhook/{botId}`
   - Verify Token: (configurado en appsettings.json)

## üìã Checklist Final

- [ ] Frontend construido y copiado al servidor
- [ ] Backend .NET ejecut√°ndose en puerto 5000
- [ ] Nginx configurado y funcionando
- [ ] SSL certificado instalado
- [ ] URLs legales accesibles p√∫blicamente
- [ ] Meta WhatsApp Business configurado
- [ ] Verificaci√≥n de webhook exitosa

---

üéâ **Tu aplicaci√≥n Aliado AI est√° lista para producci√≥n con todas las p√°ginas legales requeridas por Meta WhatsApp Business API.**